<script>
  // —— 画 520 爱心（原样保留）——
  const H=28,W=56,S=12.0,GLYPH="520";
  function drawHeart(){
    const pre=document.getElementById("heart"); let out="";
    for(let y=H;y>=-H;y--){
      let line=""; for(let x=-W;x<=W;x++){
        const X=x/S, Y=y/S;
        const inH=Math.pow(X*X+Y*Y-1,3)-X*X*Math.pow(Y,3)<=0;
        line+=inH?GLYPH:" ".repeat(GLYPH.length);
      } out+=line+"\n";
    }
    pre.textContent=out; fitToViewport();
  }
  function fitToViewport(){
    const pre=document.getElementById("heart");
    pre.style.transform="scale(1)";
    requestAnimationFrame(()=>{
      const r=pre.getBoundingClientRect();
      const vw=window.innerWidth-20, vh=window.innerHeight-150;
      pre.style.transform=`scale(${Math.min(1,vw/r.width,vh/r.height)})`;
    });
  }
  window.addEventListener("resize",fitToViewport);
  drawHeart();

  // —— APlayer：取消自动播放，改成按钮触发（兼容手机）——
  const ap = new APlayer({
    container: document.getElementById('aplayer'),
    autoplay: false,          // ★ 不自动播（移动端会被拦），等用户点按钮
    loop: 'all',
    preload: 'auto',
    audio: [{
      name:'大城小爱',
      artist:'王力宏',
      url:'https://martinmax0711.github.io/music/dachengxiaai.mp3', // ← 换成你的直链
      cover:'https://p1.music.126.net/pj-4t3bM7Ob7cP5u2A0uVQ==/109951166195658165.jpg'
    }]
  });

  // 给内部 <audio> 打上移动端必需属性
  ap.on('loadedmetadata', () => {
    const a = ap.audio;
    if (a) {
      a.setAttribute('playsinline','');
      a.setAttribute('webkit-playsinline','');
      a.crossOrigin = 'anonymous';
      a.preload = 'auto';
    }
    document.getElementById('tip').textContent='✅ 播放器已加载（点右下角播放）';
  });

  async function unlockAndPlay(){
    try{
      // 一些机型需要先把音量设定，再 play
      ap.volume(1.0, true);
      await ap.play();                       // 用户手势触发：iOS/安卓允许
      document.getElementById('playBtn').style.display='none';
      document.getElementById('tip').textContent='🎵 播放中';
    }catch(e){
      alert('播放失败：'+ (e?.message || e));
    }
  }

  // 同时监听 click 和 touchend，取其一（{once:true} 避免重复）
  const playBtn = document.getElementById('playBtn');
  playBtn.addEventListener('click', unlockAndPlay, { once:true });
  playBtn.addEventListener('touchend', (e)=>{ e.preventDefault(); unlockAndPlay(); }, { once:true });

  // 从后台回到前台时，尽量续播（不保证所有机型都生效）
  document.addEventListener('visibilitychange', () => {
    if (!document.hidden) ap.play().catch(()=>{});
  });
</script>
