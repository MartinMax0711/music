<script>
  // â€”â€” ç”» 520 çˆ±å¿ƒï¼ˆåŸæ ·ä¿ç•™ï¼‰â€”â€”
  const H=28,W=56,S=12.0,GLYPH="520";
  function drawHeart(){
    const pre=document.getElementById("heart"); let out="";
    for(let y=H;y>=-H;y--){
      let line=""; for(let x=-W;x<=W;x++){
        const X=x/S, Y=y/S;
        const inH=Math.pow(X*X+Y*Y-1,3)-X*X*Math.pow(Y,3)<=0;
        line+=inH?GLYPH:" ".repeat(GLYPH.length);
      } out+=line+"\n";
    }
    pre.textContent=out; fitToViewport();
  }
  function fitToViewport(){
    const pre=document.getElementById("heart");
    pre.style.transform="scale(1)";
    requestAnimationFrame(()=>{
      const r=pre.getBoundingClientRect();
      const vw=window.innerWidth-20, vh=window.innerHeight-150;
      pre.style.transform=`scale(${Math.min(1,vw/r.width,vh/r.height)})`;
    });
  }
  window.addEventListener("resize",fitToViewport);
  drawHeart();

  // â€”â€” APlayerï¼šå–æ¶ˆè‡ªåŠ¨æ’­æ”¾ï¼Œæ”¹æˆæŒ‰é’®è§¦å‘ï¼ˆå…¼å®¹æ‰‹æœºï¼‰â€”â€”
  const ap = new APlayer({
    container: document.getElementById('aplayer'),
    autoplay: false,          // â˜… ä¸è‡ªåŠ¨æ’­ï¼ˆç§»åŠ¨ç«¯ä¼šè¢«æ‹¦ï¼‰ï¼Œç­‰ç”¨æˆ·ç‚¹æŒ‰é’®
    loop: 'all',
    preload: 'auto',
    audio: [{
      name:'å¤§åŸå°çˆ±',
      artist:'ç‹åŠ›å®',
      url:'https://martinmax0711.github.io/music/dachengxiaai.mp3', // â† æ¢æˆä½ çš„ç›´é“¾
      cover:'https://p1.music.126.net/pj-4t3bM7Ob7cP5u2A0uVQ==/109951166195658165.jpg'
    }]
  });

  // ç»™å†…éƒ¨ <audio> æ‰“ä¸Šç§»åŠ¨ç«¯å¿…éœ€å±æ€§
  ap.on('loadedmetadata', () => {
    const a = ap.audio;
    if (a) {
      a.setAttribute('playsinline','');
      a.setAttribute('webkit-playsinline','');
      a.crossOrigin = 'anonymous';
      a.preload = 'auto';
    }
    document.getElementById('tip').textContent='âœ… æ’­æ”¾å™¨å·²åŠ è½½ï¼ˆç‚¹å³ä¸‹è§’æ’­æ”¾ï¼‰';
  });

  async function unlockAndPlay(){
    try{
      // ä¸€äº›æœºå‹éœ€è¦å…ˆæŠŠéŸ³é‡è®¾å®šï¼Œå† play
      ap.volume(1.0, true);
      await ap.play();                       // ç”¨æˆ·æ‰‹åŠ¿è§¦å‘ï¼šiOS/å®‰å“å…è®¸
      document.getElementById('playBtn').style.display='none';
      document.getElementById('tip').textContent='ğŸµ æ’­æ”¾ä¸­';
    }catch(e){
      alert('æ’­æ”¾å¤±è´¥ï¼š'+ (e?.message || e));
    }
  }

  // åŒæ—¶ç›‘å¬ click å’Œ touchendï¼Œå–å…¶ä¸€ï¼ˆ{once:true} é¿å…é‡å¤ï¼‰
  const playBtn = document.getElementById('playBtn');
  playBtn.addEventListener('click', unlockAndPlay, { once:true });
  playBtn.addEventListener('touchend', (e)=>{ e.preventDefault(); unlockAndPlay(); }, { once:true });

  // ä»åå°å›åˆ°å‰å°æ—¶ï¼Œå°½é‡ç»­æ’­ï¼ˆä¸ä¿è¯æ‰€æœ‰æœºå‹éƒ½ç”Ÿæ•ˆï¼‰
  document.addEventListener('visibilitychange', () => {
    if (!document.hidden) ap.play().catch(()=>{});
  });
</script>
